{% extends "thoughts/base.html" %}
{% load humanize %}

{% block title %}Profile{% endblock %}

{% block main %}
  <div class="profile-page">
    <h1><span class="glyphicon glyphicon-user" aria-hidden="true"></span> Profile</h1>
    {% if profileUpdate %}
      <div class="profile-update">
        {% if messages %}
          <div class="messages">
              {% for message in messages %}
              <div class="alert alert-danger" role="alert">
                {{ message }}
              </div>
              {% endfor %}
          </div>
          {% endif %}

          <form action="{% url "accounts:profile-update" profileUpdate.user.id %}" method="post" enctype="multipart/form-data">
            {% include "thoughts/form_template.html" %}
            <button type="submit" class="btn btn-success btn-md">Save</button>
          </form>
      </div>
        

    {% else %}
      <div class="row">
        <div class="avatar col-md-6">
          <img src="{{ profile.avatar.url}}" alt="Avatar" class="{{ profile.gender}}">
          <div class="username {{ profile.gender}}">{{ profile.user.username|default:"" }}</div>
        </div>
        <div class="statistics col-md-6">
          <div class="chart-wrapper">
            <canvas id="mindsetChart"></canvas>
          </div>
        </div>
      </div>
      <div class="thoughts-history">
        <h2>History</h2>
          {% if thoughts.count %}
            {% for thought in thoughts %}
              <div class="thought thought-{{ thought.status }}">
                <div class="row">
                  <div class="thought-author-info col-md-2">
                    <div class="avatar-wrapper">
                      <a href="{% url "accounts:profile-detail" thought.user.id %}">
                        <img src="{{ thought.user.profile.avatar.url }}" alt="Avatar" class="avatar {{ thought.user.profile.gender }}">
                      </a>
                    </div>
                    <div class="nickname">
                      <a href="{% url "accounts:profile-detail" thought.user.id %}">
                        <span class="{{ thought.user.profile.gender }}">{{ thought.user.username }}</span>
                      </a>
                    </div>
                  </div>

                  <a href="{% url "thoughts:detail" thought.id %}">
                    <div class="thought-content col-md-10">
                      <p>{{ thought.text }}</p>
                    </div>
                  </a>
                  {% if user == profile.user %}
                    <div class="thought-edit">
                      <a class="btn btn-primary" href="{% url "thoughts:thought-update" thought.id %}">
                        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span> Update
                      </a>
                    </div>
                  {% endif %}
                  
                </div>

                <div class="row">
                  <div class="date">{{ thought.date|naturaltime }}</div>
                  <div class="comments-quantity">Comments: ({{ thought.comment_set.count}})</div>
                </div>
                
              </div>
            {% endfor %}
          {% else %}
            <div class="alert alert-info" role="alert">
              <b>Info:</b> Here is no thoughts yet, but you can add it right now -> <a href="{% url 'thoughts:thought-add' %}">link</a>
            </div>
          {% endif %}
            
      </div>
      
    {% endif %}

  </div>
  
{% endblock main %}

{% block javascript %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
  <script>
    var mc = $('#mindsetChart'); // gc - mindsetChart
    var mindsetChart = new Chart(mc, {
      type: 'pie',
      data: {
        labels: {{ statuses_data.labels|safe }},
        datasets: [{
          data: {{ statuses_data.values|safe }},
          backgroundColor: {{ statuses_data.bgcolors|safe }},
          label: "Your mindset",
        }]
      }, //end data
      options: {
        tooltips: {
          callbacks: {
            label: function(tooltipItem, data) {
              var dataset = data.datasets[tooltipItem.datasetIndex];
              var total = dataset.data.reduce(function(previous, current){
                return previous + current;
              });
              var currentValue = dataset.data[tooltipItem.index];
              var percentage = ((currentValue / total) * 100).toFixed(2);
              return percentage + '% (' + currentValue + ')';
            }
          }
        },
        legend: {
          position: 'bottom',
        }
      }
    })
  </script>
{% endblock javascript %}
